# Self-Healing Pipeline Workflow
# Triggers when other workflows fail to analyze and auto-fix issues
#
# This workflow implements the self-improvement guideline:
# - Monitors CI/CD pipeline failures
# - Analyzes failure logs using AI
# - Attempts automated fixes when confidence is high
# - Notifies for human intervention when needed

name: Self-Healing Pipeline

on:
  # Trigger on workflow failures
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number to analyze'
        required: true
        type: number
      force_rerun:
        description: 'Force rerun even if already attempted'
        type: boolean
        default: false

permissions:
  contents: write  # For pushing fixes
  pull-requests: write  # For posting comments
  checks: read  # For reading check status
  actions: read  # For reading workflow logs

env:
  AUTOMATION_SERVER_URL: ${{ vars.AUTOMATION_SERVER_URL || 'http://localhost:3000' }}
  BOT_USERNAME: ${{ vars.BOT_USERNAME || 'xorng-bot' }}

jobs:
  # ==========================================================================
  # Analyze Failure
  # ==========================================================================
  analyze:
    name: Analyze Pipeline Failure
    runs-on: ubuntu-latest
    
    # Only run on failures (workflow_run) or manual trigger
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'failure' && 
       github.event.workflow_run.event == 'pull_request')
    
    outputs:
      should_fix: ${{ steps.analyze.outputs.should_fix }}
      pr_number: ${{ steps.context.outputs.pr_number }}
      fix_type: ${{ steps.analyze.outputs.fix_type }}
    
    steps:
      - name: Get PR Context
        id: context
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "force_rerun=${{ inputs.force_rerun }}" >> $GITHUB_OUTPUT
          else
            # Extract PR number from workflow_run event
            PR_NUMBER=$(echo '${{ toJson(github.event.workflow_run.pull_requests) }}' | jq -r '.[0].number // empty')
            echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "force_rerun=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Download workflow logs
        if: github.event_name != 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get the failed workflow run
            const runId = context.payload.workflow_run.id;
            
            // List jobs in the workflow run
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            
            // Find failed jobs
            const failedJobs = jobs.jobs.filter(job => job.conclusion === 'failure');
            
            // Download logs for failed jobs
            const logs = [];
            for (const job of failedJobs) {
              try {
                const { data: log } = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id,
                });
                logs.push({
                  jobName: job.name,
                  log: log.substring(0, 50000), // Limit log size
                });
              } catch (e) {
                console.log(`Failed to download logs for job ${job.name}: ${e.message}`);
              }
            }
            
            // Save logs to file
            fs.writeFileSync('failure-logs.json', JSON.stringify({
              runId,
              failedJobs: failedJobs.map(j => ({ id: j.id, name: j.name, conclusion: j.conclusion })),
              logs,
            }, null, 2));

      - name: Analyze failure
        id: analyze
        run: |
          # Check if we have failure logs
          if [[ -f "failure-logs.json" ]]; then
            # Parse the logs to determine failure type
            LOGS=$(cat failure-logs.json)
            
            # Simple pattern matching for common failure types
            SHOULD_FIX="false"
            FIX_TYPE=""
            
            if echo "$LOGS" | grep -qi "lint"; then
              SHOULD_FIX="true"
              FIX_TYPE="lint"
            elif echo "$LOGS" | grep -qi "typecheck\|type error\|tsc"; then
              SHOULD_FIX="true"
              FIX_TYPE="typecheck"
            elif echo "$LOGS" | grep -qi "format\|prettier"; then
              SHOULD_FIX="true"
              FIX_TYPE="format"
            elif echo "$LOGS" | grep -qi "test\|jest\|vitest"; then
              SHOULD_FIX="false"  # Tests need careful manual review
              FIX_TYPE="test"
            fi
            
            echo "should_fix=$SHOULD_FIX" >> $GITHUB_OUTPUT
            echo "fix_type=$FIX_TYPE" >> $GITHUB_OUTPUT
          else
            # Manual trigger - attempt analysis via automation server
            echo "should_fix=true" >> $GITHUB_OUTPUT
            echo "fix_type=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Notify automation server
        if: steps.context.outputs.pr_number != ''
        continue-on-error: true
        run: |
          curl -X POST "${{ env.AUTOMATION_SERVER_URL }}/api/pipeline/analyze" \
            -H "Content-Type: application/json" \
            -d '{
              "owner": "${{ github.repository_owner }}",
              "repo": "${{ github.event.repository.name }}",
              "prNumber": ${{ steps.context.outputs.pr_number }},
              "runId": "${{ github.event.workflow_run.id }}",
              "conclusion": "${{ github.event.workflow_run.conclusion }}",
              "fixType": "${{ steps.analyze.outputs.fix_type }}"
            }' || echo "Automation server not reachable"

  # ==========================================================================
  # Auto-Fix
  # ==========================================================================
  auto-fix:
    name: Apply Auto-Fix
    runs-on: ubuntu-latest
    needs: analyze
    
    if: needs.analyze.outputs.should_fix == 'true' && needs.analyze.outputs.pr_number != ''
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Apply lint fixes
        if: needs.analyze.outputs.fix_type == 'lint'
        run: |
          npm run lint:fix || npm run lint -- --fix || true
          
      - name: Apply format fixes
        if: needs.analyze.outputs.fix_type == 'format'
        run: |
          npm run format || npm run format:fix || npx prettier --write "**/*.{ts,tsx,js,jsx,json,md}" || true

      - name: Check for changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "${{ env.BOT_USERNAME }}"
          git config user.email "${{ env.BOT_USERNAME }}@users.noreply.github.com"
          
          git add -A
          git commit -m "fix: auto-fix ${{ needs.analyze.outputs.fix_type }} issues

          Applied by XORNG self-healing pipeline.
          
          Workflow run: ${{ github.event.workflow_run.html_url }}
          Fix type: ${{ needs.analyze.outputs.fix_type }}
          
          [skip ci]"
          
          git push

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.analyze.outputs.pr_number }};
            const fixType = '${{ needs.analyze.outputs.fix_type }}';
            const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';
            
            let body;
            if (hasChanges) {
              body = `## üîß Auto-Fix Applied
              
            The self-healing pipeline detected **${fixType}** issues and automatically applied fixes.
            
            A new commit has been pushed to this branch. The CI will re-run automatically.
            
            <details>
            <summary>What was fixed?</summary>
            
            - Fix type: \`${fixType}\`
            - Workflow run: [View logs](${{ github.event.workflow_run.html_url }})
            
            </details>
            
            _Applied by XORNG Self-Healing Pipeline_`;
            } else {
              body = `## ‚ÑπÔ∏è Auto-Fix Analysis
              
            The self-healing pipeline analyzed the **${fixType}** failure but no automatic fixes were applicable.
            
            Please review the [workflow logs](${{ github.event.workflow_run.html_url }}) and fix the issues manually.
            
            **Available commands:**
            - \`/autofix\` - Retry auto-fix analysis
            - \`/hold\` - Mark this PR as blocked
            
            _Analyzed by XORNG Self-Healing Pipeline_`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });

  # ==========================================================================
  # Human Intervention Required
  # ==========================================================================
  notify-human:
    name: Request Human Intervention
    runs-on: ubuntu-latest
    needs: analyze
    
    if: needs.analyze.outputs.should_fix == 'false' && needs.analyze.outputs.pr_number != ''
    
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.analyze.outputs.pr_number }};
            const fixType = '${{ needs.analyze.outputs.fix_type }}';
            
            const body = `## üö® Human Intervention Required
            
            The CI pipeline has failed with **${fixType}** errors that require manual review.
            
            The self-healing pipeline cannot automatically fix these issues because:
            ${fixType === 'test' ? '- Test failures may indicate actual bugs in the code' : '- The failure type requires careful human analysis'}
            
            **Please:**
            1. Review the [workflow logs](${{ github.event.workflow_run.html_url }})
            2. Fix the issues manually
            3. Push a new commit
            
            **Available commands:**
            - \`/autofix\` - Request another auto-fix attempt
            - \`/hold\` - Mark this PR as blocked
            
            _Analyzed by XORNG Self-Healing Pipeline_`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
            
            // Add label for tracking
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['needs-human-review'],
              });
            } catch (e) {
              console.log('Could not add label:', e.message);
            }
